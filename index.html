<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Language" content="fr">
  <title>Analyse de document d'identité — V2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      /* Palette claire jaune/orange */
      --bg: #fff9ed;               /* très clair chaud */
      --card-bg: #ffffff;          /* cartes blanches */
      --card-hover: #fff4e0;       /* survol chaud subtil */
      --border: #f4e6c7;           /* bord doux sable */
      --muted: #7a6b5a;            /* texte secondaire chaud */
      --text: #1f1300;             /* texte principal foncé chaud */
      --primary: linear-gradient(90deg,#f59e0b,#f97316); /* ambre → orange */
      --primary-solid: #f59e0b;
      --tab-active-bg: #fff1cc;    /* onglet actif pastel ambre */
      --tab-hover-bg: #fff6e0;     /* onglet hover très léger */
      --tab-active-text: #0f172a;  /* texte onglet actif */
      /* Compensation horizontale pour la présence/absence de scrollbar verticale */
      --scroll-comp: 0px;
      --font-sans: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --font-display: 'Plus Jakarta Sans', 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --font-size-base: 14px;
      --font-size-menu: 16px;
      --font-size-title: 15px;
    }
    body {
      font-family: var(--font-sans);
      font-size: var(--font-size-base);
      margin: 0; padding: 0; color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      /* Arrière-plan avec volume (tons chauds: jaunes/oranges, bandes diagonales) */
      background:
        /* grande bande diagonale avec dégradé interne (clair -> soutenu -> fondu) */
        linear-gradient(115deg,
          rgba(245,158,11,0) 0%,
          rgba(245,158,11,0) 12%,
          rgba(255,193,7,.28) 22%,
          rgba(249,115,22,.22) 38%,
          rgba(249,115,22,0) 40%,
          rgba(249,115,22,0) 46%,
          rgba(255,166,0,0) 46%,
          rgba(255,186,73,.26) 58%,
          rgba(255,166,0,.22) 74%,
          rgba(255,166,0,0) 76%
        ),
        /* contre-bande basse avec dégradé interne */
        linear-gradient(250deg,
          rgba(255,111,0,0) 0%,
          rgba(255,111,0,0) 10%,
          rgba(234,88,12,.12) 18%,
          rgba(245,158,11,.10) 28%,
          rgba(245,158,11,0) 32%
        ),
        radial-gradient(1200px 800px at 8% -10%, #fff3cc 0%, rgba(255,243,204,0) 60%),
        radial-gradient(900px 700px at 100% 10%, #fff0e6 0%, rgba(255,240,230,0) 55%),
        linear-gradient(180deg, #fff9ed 0%, #fff3d6 100%),
        var(--bg);
      background-attachment: fixed, fixed, fixed, fixed;
      background-repeat: no-repeat;
    }
    /* Formes nettes avec dégradés internes (tons bleus) */
    body::before,
    body::after {
      content: ""; position: fixed; pointer-events: none; z-index: 0;
    }
    /* Bande diagonale haute (bord net, dégradé vertical interne) */
    body::before {
      top: 0; left: -8vw; width: 116vw; height: 52vh;
      background: linear-gradient(180deg, rgba(255,239,186,1) 0%, rgba(255,205,112,.85) 55%, rgba(255,168,76,.55) 100%);
      clip-path: polygon(0 0, 100% 0, 74% 62%, 0 62%);
    }
    /* Bande diagonale basse (bord net, dégradé vertical interne) */
    body::after {
      bottom: -2vh; right: -8vw; width: 116vw; height: 58vh;
      background: linear-gradient(180deg, rgba(255,224,178,.75) 0%, rgba(255,193,112,.65) 55%, rgba(249,115,22,.45) 100%);
      clip-path: polygon(100% 100%, 0 100%, 26% 42%, 100% 42%);
    }
    header {
      padding: 22px 16px; background: linear-gradient(90deg,#fbbf24,#f97316);
      color: white; box-shadow: 0 6px 30px rgba(0,0,0,.25);
      position: sticky; top: 0; z-index: 10;
    }
    main { padding: 24px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 16px;
      backdrop-filter: blur(8px); box-shadow: 0 10px 25px rgba(0,0,0,.25);
      transition: transform .15s ease, background .2s ease, box-shadow .2s ease;
    }
    /* Réduction notable des cartes documents (Nouveau contrat) */
    .card.card-doc { padding: 10px; }
    .card.card-doc h3 { font-size: var(--font-size-title); }
    .card:hover { transform: translateY(-2px); background: var(--card-hover); box-shadow: 0 14px 30px rgba(0,0,0,.12); }
    /* Variantes vives et modernes pour documents */
    .card.card-doc.cni {
      background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
      border-color: transparent;
      box-shadow: 0 14px 34px rgba(37,99,235,.35);
      color: #fff;
    }
    .card.card-doc.cni h3, .card.card-doc.cni .status { color: #fff; }
    .card.card-doc.cni .dropzone { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.55); color: #fff; }
    .card.card-doc.cni:hover { transform: translateY(-3px); box-shadow: 0 18px 40px rgba(37,99,235,.45); }

    .card.card-doc.domicile {
      background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
      border-color: transparent;
      box-shadow: 0 14px 34px rgba(249,115,22,.35);
      color: #fff;
    }
    .card.card-doc.domicile h3, .card.card-doc.domicile .status { color: #fff; }
    .card.card-doc.domicile .dropzone { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.55); color: #fff; }
    .card.card-doc.domicile:hover { transform: translateY(-3px); box-shadow: 0 18px 40px rgba(239,68,68,.45); }

    .card.card-doc.secu {
      background: linear-gradient(135deg, #10b981 0%, #22d3ee 100%);
      border-color: transparent;
      box-shadow: 0 14px 34px rgba(16,185,129,.35);
      color: #fff;
    }
    .card.card-doc.secu h3, .card.card-doc.secu .status { color: #fff; }
    .card.card-doc.secu .dropzone { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.55); color: #fff; }
    .card.card-doc.secu:hover { transform: translateY(-3px); box-shadow: 0 18px 40px rgba(34,211,238,.45); }
    .card.card-doc.cv { background: #f2ecff; border-color: #e2d8ff; }
    .card.card-doc.cv:hover { background: #ece4ff; }
    /* Titres alignés verticalement */
    .card h3 { margin: 0 0 8px 0; min-height: 28px; display: flex; align-items: center; font-family: var(--font-display); letter-spacing: .005em; font-size: var(--font-size-title); }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); min-height: 28px; display: flex; align-items: center; font-size: var(--font-size-base); }
    .dropzone {
      border: 2px dashed #cfe1ff; border-radius: 12px; padding: 8px; text-align: center;
      transition: border-color .2s, background .2s, transform .15s;
      background: #f5faff; min-height: 44px; color: #0f172a;
      display: flex; align-items: center; justify-content: center;
      font-size: var(--font-size-base);
    }
    .dropzone.dragover { border-color: #60a5fa; background: #e8f2ff; transform: scale(1.01); }
    input[type="file"], select, input[type="text"], input[type="date"] {
      width: 100%; padding: 8px 10px; border: 1px solid #cfe1ff; border-radius: 10px;
      background: #ffffff; color: #0f172a; font-size: var(--font-size-base);
    }

    /* Espace d'affichage du nom de fichier choisi */
    .file-chosen { margin-top: 6px; font-size: 12px; color: var(--muted); min-height: 1em; }

    /* Bouton moderne pour input file */
    input[type="file"]::file-selector-button {
      appearance: none; -webkit-appearance: none;
      background-image: var(--primary);
      color: #fff; border: 0; border-radius: 10px;
      padding: 8px 14px; margin-right: 10px; font-weight: 600;
      cursor: pointer; box-shadow: 0 6px 16px rgba(99,102,241,.35);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    input[type="file"]::file-selector-button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(99,102,241,.4); }
    input[type="file"]::file-selector-button:active { transform: translateY(0); opacity: .92; box-shadow: 0 4px 12px rgba(99,102,241,.3); }
    /* Fallback WebKit */
    input[type="file"]::-webkit-file-upload-button {
      -webkit-appearance: none;
      background-image: var(--primary);
      color: #fff; border: 0; border-radius: 10px;
      padding: 8px 14px; margin-right: 10px; font-weight: 600;
      cursor: pointer; box-shadow: 0 6px 16px rgba(99,102,241,.35);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    input[type="file"]::-webkit-file-upload-button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(99,102,241,.4); }
    input[type="file"]::-webkit-file-upload-button:active { transform: translateY(0); opacity: .92; box-shadow: 0 4px 12px rgba(99,102,241,.3); }
    /* Harmonisation dropzone / input file */
    .doc-left > .dropzone,
    .doc-left > input[type="file"] { width: 100%; box-sizing: border-box; margin-left: 0; margin-right: 0; }
    .doc-left > input[type="file"] { border-radius: 12px; }
    button { margin-top: 10px; padding: 8px 14px; border-radius: 10px; border: 0; color: white; font-weight: 600; cursor: pointer; font-size: var(--font-size-base); }
    button:not(.secondary) { background-image: var(--primary); box-shadow: 0 6px 18px rgba(99,102,241,.4); }
    button.secondary { background: #374151; }
    button:disabled { opacity: .65; cursor: not-allowed; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    pre {
      white-space: pre-wrap; word-wrap: break-word; background: rgba(3,7,18,.7); color: #e5e7eb; padding: 14px; border-radius: 10px; overflow: auto;
      border: 1px solid rgba(255,255,255,0.12); min-height: 160px;
    }
    .status { margin-top: 10px; font-size: 14px; color: var(--muted); }
    .preview { display:none; }
    .preview img, .preview canvas { max-width: 100%; display: block; }
    /* Documents */
    .doc-row { display: block; margin: 0; }
    .doc-left { width: 100%; }
    .doc-right { display:none; }
    .doc-cards { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 1100px) { .doc-cards { grid-template-columns: repeat(3, 220px); gap: 10px; align-items: stretch; justify-content: center; } }
    /* Assure la même hauteur visuelle entre cartes documents */
    .doc-cards .card { height: 100%; display: flex; flex-direction: column; }

    /* Compacter verticalement les cartes documents */
    .card.card-doc { padding: 8px; }
    .card.card-doc h3 { margin: 0 0 6px 0; font-size: var(--font-size-title); }
    .card.card-doc h3 { justify-content: center; text-align: center; }
    .card.card-doc label { margin-bottom: 6px; min-height: 22px; }
    .card.card-doc .dropzone { min-height: 56px; padding: 8px; font-size: var(--font-size-base); }
    .card.card-doc input[type="file"] { width: auto; display: block; margin: 8px auto 0; border: 0; padding: 0; background: transparent; font-size: 0; }
    .card.card-doc input[type="file"]::file-selector-button { font-size: 13px; }
    .card.card-doc input[type="file"]::-webkit-file-upload-button { font-size: 13px; }
    .card.card-doc button { margin-top: 6px; padding: 6px 12px; }
    /* Uniformiser le décalage sous la barre d'onglets pour tous les onglets */
    .tab-pane { margin-top: 0; }
    .tab-pane > .card:first-child { margin-top: 0 !important; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow: hidden; border-radius: 10px; }
    th, td { border: 1px solid var(--border); text-align: left; }
    th { background: #f0f7ff; font-weight: 700; padding: 10px; color: var(--text); }
    td { padding: 0; }
    /* Champs remplis: quasi blancs avec une pointe bleutée */
    td input { width: 100%; padding: 10px; border-radius: 0; border: 1px solid #dbe8ff; background: #f8fbff; color: #0f172a; display: block; box-sizing: border-box; }

    /* Layout & Sidebar */
    .layout { display: grid; grid-template-columns: 1fr; gap: 20px; min-height: 100vh; position: relative; z-index: 1; }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: relative; order: 2; }
    }
    .sidebar { display:none; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing:.2px; margin-bottom: 14px; font-family: var(--font-display); }
    .brand .dot { width: 28px; height: 28px; border-radius: 8px; background-image: var(--primary); display:inline-block; }
    .nav { display: flex; flex-direction: column; gap: 8px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; color: var(--text); text-decoration: none; background: transparent; border: 1px solid transparent; cursor: pointer; }
    .nav-item:hover { background: var(--tab-hover-bg); }
    .nav-item.active { background: var(--tab-active-bg); border-color: transparent; color: var(--tab-active-text); }
    /* Barre d'onglets en haut (style pill) */
    .topnav-wrapper { display:flex; justify-content:center; align-items:center; height: 180px; padding: 0; margin: 0; position: static; top: auto; background: transparent; z-index: 5; width: 100%; }
    .topnav-inner { display:flex; align-items:center; gap: 18px; width: min(1200px, 94%); justify-content:center; position: relative; }
    .site-brand { position: fixed; top: 12px; left: 16px; font-weight: 800; letter-spacing: .08em; text-transform: uppercase; color: #0f172a; z-index: 20; font-family: var(--font-display); }
    .pill-nav {
      display:flex; gap: 0; align-items:center; justify-content: space-around;
      border: 1px solid #111; border-radius: 9999px; background: #fff;
      width: min(1060px, 85%);
      height: 44px; /* hauteur fixe fine, comme le modèle */
      padding: 0 28px; /* plus de padding vertical */
      margin: 0; position: relative; left: 50%; transform: translateX(calc(-50% - var(--scroll-comp)));
    }
    .pill-item { background: transparent; border: 0; color: #1a1a1a; font-weight: 600; letter-spacing:.05em; text-transform: uppercase; padding: 0 20px; cursor:pointer; font-size: var(--font-size-menu); line-height: 44px; margin: 0; font-family: var(--font-display); }
    /* Annule le style global des boutons pour la nav */
    .pill-nav .pill-item { background: transparent !important; background-image: none !important; box-shadow: none !important; border: 0 !important; margin-top: 0 !important; }
    .pill-item:hover { color: #000; background: transparent; }
    .pill-item.active { color: #000; background: transparent; text-decoration: none; font-weight: 500; }
    .pill-item.cat-active { font-weight: 700; }
    .pill-item:focus { outline: none; }
    /* Sous-menu texte (aucun encadré) */
    .subnav { display:none; position: absolute; top: 66px; left: 50%; transform: translateX(-50%); gap: 22px; align-items:center; justify-content:center; }
    .subnav.show { display:flex; animation: fadeIn .16s ease; }
    .subnav .sub-item { background: transparent !important; border: 0 !important; box-shadow: none !important; margin-top: 0 !important; color: #1a1a1a; font-weight: 500; cursor: pointer; padding: 0; font-size: 18px; }
    .subnav .sub-item:hover { text-decoration: underline; }
    .subnav .sub-item.active { text-decoration: underline; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -6px); } to { opacity: 1; transform: translate(-50%, 0); } }
    #storeSelect { width: 20%; min-width: 140px; max-width: 220px; }
    #contractsStore {
      width: 20%; min-width: 140px; max-width: 220px;
      padding: 10px 12px; border: 1px solid #cfe1ff; border-radius: 10px;
      background: #ffffff; color: #0f172a;
    }
    /* style en-tête actif pour filtre */
    #contractsTable thead th.contracts-col.active { background: var(--tab-active-bg); color: var(--tab-active-text); }

    /* Réduction largeur des cartes Variables & Société (police uniforme) */
    .compact-info { width: 70%; margin-left: auto; margin-right: auto; }
    @media (max-width: 900px) { .compact-info { width: 100%; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span> <span>LAB ADMIN</span></div>
    </aside>
    <div class="topnav-wrapper">
      <div class="topnav-inner">
        <div class="site-brand">LAB ASSIST</div>
        <div class="pill-nav">
        <button class="pill-item active" id="nav-analyse" data-tab="tab-analyse">Administratif</button>
        <button class="pill-item" id="nav-contrats" data-tab="tab-contrats">Recrutement</button>
        <button class="pill-item" id="nav-settings" data-tab="tab-settings">Planning</button>
        </div>
        <div id="subnav" class="subnav"></div>
      </div>
    </div>
    <main>
      <div id="tab-analyse" class="tab-pane">
        <div class="doc-cards">
      <div class="card card-doc cni">
        <h3>Carte d'identité (CNI) ou passeport</h3>
        <form id="form-cni">
          <div class="doc-row">
            <div class="doc-left">
              <div id="dropzone-cni" class="dropzone">Glissez-déposez le fichier ici</div>
              <input id="file-cni" name="file" type="file" accept="image/*,.pdf" capture="environment" required>
              <div class="file-chosen" id="chosen-cni"></div>
            </div>
          </div>
          <div class="row">
            <button id="clearBtn-cni" type="button" class="secondary">Effacer</button>
          </div>
          <div class="status" id="status-cni"></div>
        </form>
      </div>

      <div class="card card-doc domicile">
        <h3>Justificatif de domicile<br></h3>
        <form id="form-domicile">
          <div class="doc-row">
            <div class="doc-left">
              <div id="dropzone-domicile" class="dropzone">Glissez-déposez le fichier ici</div>
              <input id="file-domicile" name="file" type="file" accept="image/*,.pdf" required>
              <div class="file-chosen" id="chosen-domicile"></div>
            </div>
          </div>
          <div class="row">
            <button id="clearBtn-domicile" type="button" class="secondary">Effacer</button>
          </div>
          <div class="status" id="status-domicile"></div>
        </form>
      </div>
      <div class="card card-doc secu">
        <h3>Carte Vitale / Attestation de droits</h3>
        <form id="form-secu">
          <div class="doc-row">
            <div class="doc-left">
              <div id="dropzone-secu" class="dropzone">Glissez-déposez le fichier ici</div>
              <input id="file-secu" name="file" type="file" accept="image/*,.pdf" required>
              <div class="file-chosen" id="chosen-secu"></div>
            </div>
          </div>
          <div class="row">
            <button id="clearBtn-secu" type="button" class="secondary">Effacer</button>
          </div>
          <div class="status" id="status-secu"></div>
        </form>
      </div>
    </div>

    <div style="margin-top:28px; display:flex; flex-direction:column; align-items:center">
      <button id="analyzeAllBtn" type="button" style="min-width:280px; width:100%; max-width:480px">Analyser</button>
      <div class="status" id="status-analyze-all" style="text-align:center"></div>
    </div>

    

    <div class="card compact-info" style="margin-top:16px">
      <div class="row" style="justify-content: space-between; align-items:center">
        <h3 style="margin:0">Variables</h3>
        <div class="row"></div>
      </div>
      <div style="overflow-x:auto">
        <table id="resultTable">
          <thead>
            <tr>
              <th>Prénom</th>
              <th>Nom</th>
              <th>Date de naissance</th>
              <th>Lieu de naissance</th>
              <th>Adresse</th>
              <th>Nationalité</th>
              <th>Numéro de sécu</th>
              <th>Date de début</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input id="prenomInput" placeholder="Prénom"></td>
              <td><input id="nomInput" placeholder="Nom"></td>
              <td><input id="dateNaissanceInput" placeholder="DD/MM/YYYY"></td>
              <td><input id="lieuNaissanceInput" placeholder="Ville / Lieu"></td>
              <td><input id="adresseInput" placeholder="Adresse"></td>
              <td><input id="nationaliteInput" placeholder="Nationalité"></td>
              <td><input id="numeroSecuInput" placeholder="Numéro de sécu"></td>
              <td><input id="dateDebutInput" placeholder="DD/MM/YYYY"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card compact-info" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Société</h3>
      <div class="row" style="align-items:center">
        <select id="storeSelect">
          <option value="AEJB">AEJB</option>
          <option value="JAB">JAB</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; flex-direction:column; align-items:center">
      <button id="generateBtn" type="button" style="min-width:280px; width:100%; max-width:480px">Générer Contrat</button>
      <div class="status" id="status-generate" style="text-align:center"></div>
    </div>

      </div>
      <div id="tab-contrats" class="tab-pane" style="display:none">
        <div class="card">
          <h3 style="margin:0 0 12px 0">Contrats</h3>
          <div class="row" style="gap:8px; align-items:center; margin-bottom:10px">
            <label style="margin:0">Magasin</label>
            <select id="contractsStore">
              <option value="">Tous</option>
              <option value="AEJB">AEJB</option>
              <option value="JAB">JAB</option>
            </select>
            <input id="contractsSearch" type="text" placeholder="Recherche (prénom, nom, NSS, adresse)" style="flex:1; min-width:220px">
            <button id="contractsRefresh" type="button" class="secondary">Rafraîchir</button>
            <a class="nav-item" href="/contracts/export.csv" style="text-decoration:none; display:inline-flex; padding:8px 12px">Exporter CSV</a>
          </div>
          <div style="overflow-x:auto">
            <table id="contractsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th data-key="store" class="contracts-col">Magasin</th>
                  <th data-key="prenom" class="contracts-col">Prénom</th>
                  <th data-key="nom" class="contracts-col">Nom</th>
                  <th data-key="date_debut" class="contracts-col">Date début</th>
                  <th>PDF</th>
                  <th>Créé le</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
          <div class="status" id="contractsStatus"></div>
        </div>
      </div>
      <div id="tab-candidates" class="tab-pane" style="display:none">
        <div class="card compact-info">
          <h3 style="margin:0 0 12px 0">Liste des candidats</h3>
          <div class="status">Les candidats apparaîtront ici après l'analyse des nouveaux CV.</div>
          <div style="overflow-x:auto; margin-top:8px">
            <table id="candidatesTable">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Téléphone</th>
                  <th>Poste</th>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="tab-analyses" class="tab-pane" style="display:none">
        <div class="card compact-info">
          <h3 style="margin:0 0 12px 0">Analyses précédentes</h3>
          <div id="analysesHistory" class="status">Aucune analyse enregistrée pour le moment.</div>
        </div>
      </div>
      <div id="tab-cv-analyse" class="tab-pane" style="display:none">
        <div class="card card-doc cv compact-info">
          <h3>Analyse nouveaux CV</h3>
          <form id="form-cv">
            <label for="files-cv">Importer un ou plusieurs CV (PDF, DOCX, images) ou déposez-les ci-dessous</label>
            <div class="doc-row">
              <div class="doc-left">
                <div id="dropzone-cv" class="dropzone">Glissez-déposez les fichiers ici</div>
                <input id="files-cv" name="files" type="file" accept=".pdf,.doc,.docx,image/*" multiple>
              </div>
            </div>
            <div class="row">
              <button id="clearBtn-cv" type="button" class="secondary">Effacer</button>
              <button id="analyzeBtn-cv" type="button" disabled>Analyser (bientôt)</button>
            </div>
            <div class="status" id="status-cv"></div>
          </form>
        </div>
        <div class="card compact-info" style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Sélection</h3>
          <div id="cv-list" class="status">Aucun fichier sélectionné pour le moment.</div>
        </div>
      </div>
      <div id="tab-criteres" class="tab-pane" style="display:none">
        <div class="card compact-info">
          <h3 style="margin:0 0 8px 0">Critères par poste</h3>
          <div class="row" style="align-items:center; gap:12px">
            <label style="margin:0">Poste</label>
            <select id="criteriaRole" style="min-width:220px">
              <option value="Vendeur polyvalent">Vendeur polyvalent</option>
              <option value="Caissier(ère)">Caissier(ère)</option>
              <option value="Adjoint(e) responsable">Adjoint(e) responsable</option>
              <option value="Manager de magasin">Manager de magasin</option>
            </select>
            <div class="status" id="criteriaStatus"></div>
          </div>
        </div>
        <div class="card compact-info" style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Critères proposés (coeff. 0–3)</h3>
          <div style="display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center">
            <div>Années d’expérience (alimentation/restauration)</div>
            <input id="crit-exp-alim" type="range" min="0" max="3" step="1" value="2">

            <div>Expérience chez Naturalia/Monoprix</div>
            <input id="crit-exp-enseigne" type="range" min="0" max="3" step="1" value="2">

            <div>Langue maternelle: Français</div>
            <input id="crit-fr-maternel" type="range" min="0" max="3" step="1" value="2">

            <div>Fiabilité (ancienneté max)</div>
            <input id="crit-fiabilite" type="range" min="0" max="3" step="1" value="2">

            <div>Motivation (présence/pertinence)</div>
            <input id="crit-motivation" type="range" min="0" max="3" step="1" value="2">
          </div>
          <div class="status" style="margin-top:6px">Glissez la jauge pour ajuster le coefficient (0 = ignoré).</div>
        </div>
        <div class="card compact-info" style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Critères personnalisés (3 max)</h3>
          <div style="display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center">
            <input id="free-1" type="text" placeholder="Critère personnalisé #1 (ex: proximité Toulouse)">
            <input id="free-1-coef" type="range" min="0" max="3" step="1" value="0">
            <input id="free-2" type="text" placeholder="Critère personnalisé #2">
            <input id="free-2-coef" type="range" min="0" max="3" step="1" value="0">
            <input id="free-3" type="text" placeholder="Critère personnalisé #3">
            <input id="free-3-coef" type="range" min="0" max="3" step="1" value="0">
          </div>
          <div class="status" style="margin-top:6px">Les critères libres sont pris en compte par l’agent avec leur coefficient.</div>
        </div>
      </div>
      <div id="tab-settings" class="tab-pane" style="display:none">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Paramètres</h3>
          <div class="status">Options à venir.</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const formCNI = document.getElementById('form-cni');
    const fileCNI = document.getElementById('file-cni');
    const dropCNI = document.getElementById('dropzone-cni');
    const statusCNI = document.getElementById('status-cni');
    const chosenCNI = document.getElementById('chosen-cni');

    const formDOM = document.getElementById('form-domicile');
    const fileDOM = document.getElementById('file-domicile');
    const dropDOM = document.getElementById('dropzone-domicile');
    const statusDOM = document.getElementById('status-domicile');
    const chosenDOM = document.getElementById('chosen-domicile');

    const formSECU = document.getElementById('form-secu');
    const fileSECU = document.getElementById('file-secu');
    const dropSECU = document.getElementById('dropzone-secu');
    const statusSECU = document.getElementById('status-secu');
    const chosenSECU = document.getElementById('chosen-secu');
    const analyzeAllBtn = document.getElementById('analyzeAllBtn');
    const statusAnalyzeAll = document.getElementById('status-analyze-all');
    // Prévisualisations supprimées
    const prenomInput = document.getElementById('prenomInput');
    const nomInput = document.getElementById('nomInput');
    const dateNaissanceInput = document.getElementById('dateNaissanceInput');
    const lieuNaissanceInput = document.getElementById('lieuNaissanceInput');
    const adresseInput = document.getElementById('adresseInput');
    const nationaliteInput = document.getElementById('nationaliteInput');
    const numeroSecuInput = document.getElementById('numeroSecuInput');
    const dateDebutInput = document.getElementById('dateDebutInput');
    const storeSelect = document.getElementById('storeSelect');
    const generateBtn = document.getElementById('generateBtn');
    const statusGenerate = document.getElementById('status-generate');

    function getTodayDDMMYYYY() {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // Navigation par onglets (sidebar)
    const tabs = ['tab-analyse','tab-contrats','tab-candidates','tab-cv-analyse','tab-criteres','tab-analyses','tab-settings'];
    function adjustPillNavCompensation() {
      const docEl = document.documentElement;
      const needsScroll = docEl.scrollHeight > docEl.clientHeight;
      const scrollbarWidth = Math.max(0, window.innerWidth - docEl.clientWidth);
      const extra = 8; // réglage fin supplémentaire pour les pages sans scrollbar
      const comp = needsScroll ? 0 : ((scrollbarWidth > 0 ? scrollbarWidth / 2 : 0) + extra);
      docEl.style.setProperty('--scroll-comp', comp + 'px');
    }

    const activateTab = (id) => {
      tabs.forEach(t => {
        const el = document.getElementById(t);
        if (el) el.style.display = (t === id) ? 'block' : 'none';
      });
      document.querySelectorAll('.nav-item, .pill-item').forEach(btn => {
        const tid = btn.getAttribute('data-tab');
        btn.classList.toggle('active', tid === id);
      });
      // Assure une position identique de la barre d'onglets après changement d'onglet
      try { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch {}
      // Ajuste la compensation après le basculement d'onglet
      adjustPillNavCompensation();
    };
    const navAnalyse = document.getElementById('nav-analyse');
    const navContrats = document.getElementById('nav-contrats');
    const navSettings = document.getElementById('nav-settings');
    const subnavEl = document.getElementById('subnav');

    function setCategoryActive(key) {
      [navAnalyse, navContrats, navSettings].forEach(el => el && el.classList.remove('cat-active'));
      if (key === 'admin' && navAnalyse) navAnalyse.classList.add('cat-active');
      if (key === 'recrut' && navContrats) navContrats.classList.add('cat-active');
      if (key === 'plan' && navSettings) navSettings.classList.add('cat-active');
      // Sous-menu
      subnavEl.innerHTML = '';
      subnavEl.classList.remove('show');
      if (key === 'admin') {
        const items = [
          { label: 'Nouveau contrat', tab: 'tab-analyse' },
          { label: 'Documents', tab: 'tab-contrats', onSelect: () => loadContracts() },
          { label: 'Paramètres', tab: 'tab-settings' }
        ];
        items.forEach((it, idx) => {
          const b = document.createElement('button');
          b.className = 'sub-item' + (idx === 0 ? ' active' : '');
          b.textContent = it.label;
          b.addEventListener('click', () => {
            subnavEl.querySelectorAll('.sub-item').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            activateTab(it.tab);
            if (typeof it.onSelect === 'function') it.onSelect();
          });
          subnavEl.appendChild(b);
        });
        subnavEl.classList.add('show');
        // Active par défaut "Nouveau contrat"
        activateTab('tab-analyse');
      } else if (key === 'recrut') {
        const items = [
          { label: 'Listes candidats', tab: 'tab-candidates' },
          { label: 'Analyse nouveaux CV', tab: 'tab-cv-analyse' },
          { label: 'Critères', tab: 'tab-criteres' },
          { label: 'Analyses précédentes', tab: 'tab-analyses', onSelect: () => renderAnalysesHistory() }
        ];
        items.forEach((it, idx) => {
          const b = document.createElement('button');
          b.className = 'sub-item' + (idx === 1 ? ' active' : '');
          b.textContent = it.label;
          b.addEventListener('click', () => {
            subnavEl.querySelectorAll('.sub-item').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            activateTab(it.tab);
            if (typeof it.onSelect === 'function') it.onSelect();
          });
          subnavEl.appendChild(b);
        });
        subnavEl.classList.add('show');
        activateTab('tab-cv-analyse');
      } else if (key === 'plan') {
        const labels = ['Historique','Nouveau planning','Paramètres'];
        labels.forEach(t => {
          const b = document.createElement('button');
          b.className = 'sub-item';
          b.textContent = t;
          b.disabled = true;
          subnavEl.appendChild(b);
        });
        subnavEl.classList.add('show');
      }
    }

    if (navAnalyse) navAnalyse.addEventListener('click', () => setCategoryActive('admin'));
    if (navContrats) navContrats.addEventListener('click', () => setCategoryActive('recrut'));
    if (navSettings) navSettings.addEventListener('click', () => setCategoryActive('plan'));
    // Ajustements init
    window.addEventListener('resize', adjustPillNavCompensation);
    // Onglet/catégorie par défaut
    setCategoryActive('admin');
    adjustPillNavCompensation();

    formCNI.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileCNI.files[0];
      if (!file) { alert('Sélectionnez un fichier CNI.'); return; }

      const fd = new FormData();
      fd.append('file', file, file.name || 'document');
      fd.append('doc_type', 'cni');

      statusCNI.textContent = 'Analyse en cours…';

      try {
        const res = await fetch('/extract', { method: 'POST', body: fd });
        const body = await res.json();
        if (!res.ok) {
          throw new Error(body?.detail || 'Erreur serveur');
        }
        if (!body?.success) {
          throw new Error('Extraction échouée');
        }
        statusCNI.textContent = 'Terminé';
        updateTableFromCNI(body.data);
        dateDebutInput.value = getTodayDDMMYYYY();
      } catch (err) {
        statusCNI.textContent = 'Erreur: ' + (err?.message || String(err));
      } finally {}
    });

    // Drag & drop util
    const setDrag = (el, on) => el.classList.toggle('dragover', on);
    const wireDrop = (el, input) => {
      el.addEventListener('dragover', (e) => { e.preventDefault(); setDrag(el, true); });
      el.addEventListener('dragleave', (e) => { e.preventDefault(); setDrag(el, false); });
      el.addEventListener('drop', (e) => { e.preventDefault(); setDrag(el, false); if (e.dataTransfer.files?.length) { input.files = e.dataTransfer.files; input.dispatchEvent(new Event('change')); } });
    };
    wireDrop(dropCNI, fileCNI);
    wireDrop(dropDOM, fileDOM);
    wireDrop(dropSECU, fileSECU);

    // Affichage des noms de fichiers sélectionnés
    function renderChosen(target, files) {
      if (!target) return;
      const n = files && files.length ? files.length : 0;
      target.textContent = n ? (n === 1 ? files[0].name : `${n} fichier(s) sélectionné(s)`) : '';
    }
    if (fileCNI) fileCNI.addEventListener('change', () => renderChosen(chosenCNI, fileCNI.files));
    if (fileDOM) fileDOM.addEventListener('change', () => renderChosen(chosenDOM, fileDOM.files));
    if (fileSECU) fileSECU.addEventListener('change', () => renderChosen(chosenSECU, fileSECU.files));
    // CV (statique)
    const formCV = document.getElementById('form-cv');
    const filesCV = document.getElementById('files-cv');
    const dropCV = document.getElementById('dropzone-cv');
    const statusCV = document.getElementById('status-cv');
    const clearBtnCV = document.getElementById('clearBtn-cv');
    const analyzeBtnCV = document.getElementById('analyzeBtn-cv');
    const cvList = document.getElementById('cv-list');
    if (dropCV && filesCV) wireDrop(dropCV, filesCV);
    if (clearBtnCV && filesCV && statusCV && cvList) clearBtnCV.addEventListener('click', () => { filesCV.value=''; statusCV.textContent=''; cvList.textContent='Aucun fichier sélectionné pour le moment.'; });
    if (filesCV && cvList) filesCV.addEventListener('change', () => {
      const n = filesCV.files ? filesCV.files.length : 0;
      cvList.textContent = n ? `${n} fichier(s) sélectionné(s).` : 'Aucun fichier sélectionné pour le moment.';
      if (analyzeBtnCV) analyzeBtnCV.disabled = n === 0;
    });

    // Helpers preview supprimés

    // Effacer -> reset preview + champs
    const clearBtnCNI = document.getElementById('clearBtn-cni');
    const clearBtnDOM = document.getElementById('clearBtn-domicile');
    const clearBtnSECU = document.getElementById('clearBtn-secu');
    if (clearBtnCNI) clearBtnCNI.addEventListener('click', () => { fileCNI.value=''; statusCNI.textContent=''; if (chosenCNI) chosenCNI.textContent=''; });
    if (clearBtnDOM) clearBtnDOM.addEventListener('click', () => { fileDOM.value=''; statusDOM.textContent=''; if (chosenDOM) chosenDOM.textContent=''; });
    if (clearBtnSECU) clearBtnSECU.addEventListener('click', () => { fileSECU.value=''; statusSECU.textContent=''; if (chosenSECU) chosenSECU.textContent=''; });

    // Analyse unique pour les 3 documents en parallèle
    async function postExtractFormData(fd) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60000);
      try {
        const res = await fetch('/extract', { method: 'POST', body: fd, signal: controller.signal });
        const txt = await res.text();
        let body = null; try { body = txt ? JSON.parse(txt) : null; } catch {}
        if (!res.ok) throw new Error(body?.detail || txt || 'Erreur serveur');
        if (!body?.success) throw new Error('Extraction échouée');
        return body;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    async function analyzeAll() {
      const cniFile = fileCNI.files[0];
      const domFile = fileDOM.files[0];
      const secuFile = fileSECU.files[0];
      if (!cniFile && !domFile && !secuFile) {
        statusAnalyzeAll.textContent = 'Sélectionnez au moins un document.';
        return;
      }
      if (analyzeAllBtn) analyzeAllBtn.disabled = true;
      // Date de début par défaut: aujourd'hui
      dateDebutInput.value = getTodayDDMMYYYY();

      // Statuts init
      if (cniFile) statusCNI.textContent = 'Analyse en cours…';
      if (domFile) statusDOM.textContent = 'Analyse en cours…';
      if (secuFile) statusSECU.textContent = 'Analyse en cours…';
      statusAnalyzeAll.textContent = 'Analyses en parallèle…';

      const tasks = [];
      const aggregated = {};

      if (cniFile) {
        const fd = new FormData();
        fd.append('file', cniFile, cniFile.name || 'cni');
        fd.append('doc_type', 'cni');
        tasks.push(
          postExtractFormData(fd)
            .then((body) => {
              aggregated.cni = body.data;
              updateTableFromCNI(body.data);
              dateDebutInput.value = getTodayDDMMYYYY();
              statusCNI.textContent = 'Terminé';
            })
            .catch((err) => {
              statusCNI.textContent = 'Erreur: ' + (err?.message || String(err));
            })
        );
      }

      if (domFile) {
        const fd = new FormData();
        fd.append('file', domFile, domFile.name || 'domicile');
        fd.append('doc_type', 'domicile');
        tasks.push(
          postExtractFormData(fd)
            .then((body) => {
              aggregated.domicile = body.data;
              if (body.data && typeof body.data === 'object') {
                if (body.data.adresse) adresseInput.value = body.data.adresse;
              }
              dateDebutInput.value = getTodayDDMMYYYY();
              statusDOM.textContent = 'Terminé';
            })
            .catch((err) => {
              statusDOM.textContent = 'Erreur: ' + (err?.message || String(err));
            })
        );
      }

      if (secuFile) {
        const fd = new FormData();
        fd.append('file', secuFile, secuFile.name || 'secu');
        fd.append('doc_type', 'secu');
        tasks.push(
          postExtractFormData(fd)
            .then((body) => {
              aggregated.secu = body.data;
              if (body.data && typeof body.data === 'object') {
                if (body.data.numero_secu) numeroSecuInput.value = body.data.numero_secu;
              }
              dateDebutInput.value = getTodayDDMMYYYY();
              statusSECU.textContent = 'Terminé';
            })
            .catch((err) => {
              statusSECU.textContent = 'Erreur: ' + (err?.message || String(err));
            })
        );
      }

      try {
        const results = await Promise.allSettled(tasks);
        const errors = results.filter(r => r.status === 'rejected').length;
        statusAnalyzeAll.textContent = errors ? `Terminé avec erreurs (${errors}).` : 'Terminé.';
      } finally {
        if (analyzeAllBtn) analyzeAllBtn.disabled = false;
      }
    }

    if (analyzeAllBtn) analyzeAllBtn.addEventListener('click', analyzeAll);

    // -------- Critères: collecte & envoi --------
    function getCriteriaConfig() {
      const roleSel = document.getElementById('criteriaRole');
      const role = roleSel ? roleSel.value : 'Vendeur polyvalent';
      const cfg = {};
      const val = (id) => { const el = document.getElementById(id); return el ? parseInt(el.value || '0', 10) : 0; };
      cfg['experience_alim_restauration'] = { label: 'Expérience (alimentation/restauration)', coefficient: val('crit-exp-alim') };
      cfg['experience_naturalia_monoprix'] = { label: 'Expérience Naturalia/Monoprix', coefficient: val('crit-exp-enseigne') };
      cfg['francais_maternel'] = { label: 'Français maternel', coefficient: val('crit-fr-maternel') };
      cfg['fiabilite_tenure'] = { label: 'Fiabilité (ancienneté max)', coefficient: val('crit-fiabilite') };
      cfg['motivation_pertinence'] = { label: 'Motivation (pertinence)', coefficient: val('crit-motivation') };
      // critères libres
      const free = [];
      for (let i=1;i<=3;i++) {
        const t = document.getElementById('free-'+i);
        const c = document.getElementById('free-'+i+'-coef');
        const label = t ? String(t.value||'').trim() : '';
        const coef = c ? parseInt(c.value||'0',10) : 0;
        if (label && coef >= 0) free.push({ label, coefficient: coef });
      }
      return { role, criteria: cfg, freeCriteria: free };
    }

    async function analyzeCVs() {
      if (!filesCV || !filesCV.files?.length) { statusCV.textContent = 'Sélectionnez des fichiers.'; return; }
      const total = filesCV.files.length;
      statusCV.textContent = `Analyse des CV en cours… (0/${total})`;
      const conf = getCriteriaConfig();
      const fd = new FormData();
      fd.append('role', conf.role);
      fd.append('criteria', JSON.stringify(conf.criteria));
      Array.from(filesCV.files).forEach((f) => fd.append('files', f, f.name||'cv'));
      try {
        const res = await fetch('/recruitment/analyze', { method: 'POST', body: fd });
        const txt = await res.text(); let body = null; try { body = txt? JSON.parse(txt): null; } catch {}
        if (!res.ok) throw new Error(body?.detail || txt || 'Erreur serveur');
        statusCV.textContent = `Analyse terminée (${total}/${total})`;
        if (body && body.candidats && Array.isArray(body.candidats)) {
          renderCandidatesList(body.candidats, conf.role);
          saveAnalysisHistory({ date: new Date().toISOString(), role: conf.role, candidates: body.candidats });
          // basculer vers l’onglet Liste des candidats
          activateTab('tab-candidates');
          // activer visuellement le sous-item
          const sub = document.getElementById('subnav');
          if (sub) {
            sub.querySelectorAll('.sub-item').forEach(x => x.classList.remove('active'));
            // sélectionner l'item correspondant (premier bouton)
            const first = sub.querySelector('.sub-item');
            if (first) first.classList.add('active');
          }
        }
      } catch (e) {
        statusCV.textContent = 'Erreur: ' + (e?.message || String(e));
      }
    }

    if (analyzeBtnCV) analyzeBtnCV.addEventListener('click', analyzeCVs);

    function renderCandidatesList(list, role) {
      const table = document.getElementById('candidatesTable');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      for (const c of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nom||''}</td>
          <td>${c.prenom||''}</td>
          <td>${c.telephone||''}</td>
          <td>${c.poste||role||''}</td>
          <td>${(typeof c.score==='number'? c.score.toFixed(2): (c.score||''))}</td>
          
        `;
        tbody.appendChild(tr);
      }
    }

    // ------ Historique des analyses (localStorage) ------
    function saveAnalysisHistory(entry) {
      try {
        const key = 'cvAnalysesHistory';
        const cur = JSON.parse(localStorage.getItem(key) || '[]');
        cur.unshift(entry);
        localStorage.setItem(key, JSON.stringify(cur).slice(0, 2000000));
      } catch {}
    }

    function formatDateFrIso(iso) {
      try {
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
      } catch { return iso; }
    }

    function renderAnalysesHistory() {
      const host = document.getElementById('analysesHistory');
      if (!host) return;
      let list = [];
      try { list = JSON.parse(localStorage.getItem('cvAnalysesHistory') || '[]'); } catch {}
      if (!Array.isArray(list) || list.length === 0) { host.textContent = 'Aucune analyse enregistrée pour le moment.'; return; }
      host.textContent = '';
      list.forEach((entry, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginTop = idx===0 ? '0' : '12px';
        const h = document.createElement('h3');
        h.style.margin = '0 0 8px 0';
        h.textContent = `Analyse du ${formatDateFrIso(entry.date)} — Poste: ${entry.role||''}`;
        card.appendChild(h);
        const wrap = document.createElement('div');
        wrap.style.overflowX = 'auto';
        const tbl = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Nom</th><th>Prénom</th><th>Téléphone</th><th>Poste</th><th>Score</th></tr>';
        const tbody = document.createElement('tbody');
        (entry.candidates||[]).forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${c.nom||''}</td><td>${c.prenom||''}</td><td>${c.telephone||''}</td><td>${c.poste||entry.role||''}</td><td>${(typeof c.score==='number'? c.score.toFixed(2): (c.score||''))}</td>`;
          tbody.appendChild(tr);
        });
        tbl.appendChild(thead); tbl.appendChild(tbody);
        wrap.appendChild(tbl);
        card.appendChild(wrap);
        host.appendChild(card);
      });
    }

    // Soumission DOMICILE
    formDOM.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileDOM.files[0];
      if (!file) { alert('Sélectionnez un justificatif de domicile.'); return; }
      const fd = new FormData();
      fd.append('file', file, file.name || 'document');
      fd.append('doc_type', 'domicile');
      statusDOM.textContent = 'Analyse en cours…';
      try {
        const res = await fetch('/extract', { method: 'POST', body: fd });
        const body = await res.json();
        if (!res.ok || !body?.success) throw new Error(body?.detail || 'Erreur');
        statusDOM.textContent = 'Terminé';
        // Met à jour uniquement l'adresse
        if (body.data && typeof body.data === 'object') {
          if (body.data.adresse) adresseInput.value = body.data.adresse;
        }
        dateDebutInput.value = getTodayDDMMYYYY();
      } catch (err) {
        statusDOM.textContent = 'Erreur: ' + (err?.message || String(err));
      }
    });

    // Soumission SECU
    formSECU.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileSECU.files[0];
      if (!file) { alert('Sélectionnez une Carte Vitale ou attestation.'); return; }
      const fd = new FormData();
      fd.append('file', file, file.name || 'document');
      fd.append('doc_type', 'secu');
      statusSECU.textContent = 'Analyse en cours…';
      try {
        const res = await fetch('/extract', { method: 'POST', body: fd });
        const body = await res.json();
        if (!res.ok || !body?.success) throw new Error(body?.detail || 'Erreur');
        statusSECU.textContent = 'Terminé';
        if (body.data && typeof body.data === 'object') {
          if (body.data.numero_secu) numeroSecuInput.value = body.data.numero_secu;
        }
        dateDebutInput.value = getTodayDDMMYYYY();
      } catch (err) {
        statusSECU.textContent = 'Erreur: ' + (err?.message || String(err));
      }
    });

    // Mise à jour dédiée CNI: ne remplit que Prénom, Nom, Date_de_naissance, Lieu de naissance, Nationalité
    function updateTableFromCNI(data) {
      if (!data || typeof data !== 'object') return;
      const lc = {};
      for (const k of Object.keys(data)) {
        if (typeof data[k] === 'string') lc[k.toLowerCase()] = data[k];
      }
      const pick = (...keys) => {
        for (const k of keys) {
          if (lc[k] !== undefined && lc[k] !== null && String(lc[k]).trim() !== '') return lc[k];
        }
        return '';
      };
      const normalizeDate = (s) => {
        if (!s) return s;
        const v = String(s).trim();
        const mIso = v.match(/^\s*(\d{4})-(\d{2})-(\d{2})/);
        if (mIso) return `${mIso[3]}/${mIso[2]}/${mIso[1]}`;
        const mDash = v.match(/^\s*(\d{2})-(\d{2})-(\d{4})/);
        if (mDash) return `${mDash[1]}/${mDash[2]}/${mDash[3]}`;
        return v;
      };
      prenomInput.value = pick('prenom', 'prénom', 'first_name', 'firstname');
      nomInput.value = pick('nom', 'last_name', 'lastname', 'name');
      dateNaissanceInput.value = normalizeDate(pick('date_naissance', 'date de naissance', 'birthdate', 'dob'));
      // Lieu de naissance uniquement, n'affecte pas l'adresse
      const maybeLieu = pick('lieu_naissance', 'lieu de naissance', 'birthplace', 'place_of_birth', 'birth_place');
      if (maybeLieu) lieuNaissanceInput.value = maybeLieu;
      nationaliteInput.value = pick('nationalite', 'nationalité', 'nationality');
    }

    // Utilitaires valeurs tableau
    const getTableRowValues = () => [
      prenomInput.value, nomInput.value, dateNaissanceInput.value,
      lieuNaissanceInput.value, adresseInput.value, nationaliteInput.value,
      numeroSecuInput.value, dateDebutInput.value
    ];
    const copyTableValues = async () => {
      const tsv = getTableRowValues().join('\t');
      try { await navigator.clipboard.writeText(tsv); (statusCNI||statusDOM||statusSECU).textContent = 'Tableau copié'; }
      catch { (statusCNI||statusDOM||statusSECU).textContent = 'Impossible de copier'; }
    };

    // Remplissage du tableau depuis les données JSON
    function updateTableFromData(data) {
      if (!data || typeof data !== 'object') return;
      const lc = {};
      for (const k of Object.keys(data)) {
        if (typeof data[k] === 'string') lc[k.toLowerCase()] = data[k];
      }
      const pick = (...keys) => {
        for (const k of keys) {
          if (lc[k] !== undefined && lc[k] !== null && String(lc[k]).trim() !== '') return lc[k];
        }
        return '';
      };
      prenomInput.value = pick('prenom', 'prénom', 'first_name', 'firstname');
      nomInput.value = pick('nom', 'last_name', 'lastname', 'name');
      dateNaissanceInput.value = pick('date_naissance', 'date de naissance', 'birthdate', 'dob');
      lieuNaissanceInput.value = pick('lieu_naissance', 'lieu de naissance', 'birthplace', 'place_of_birth', 'birth_place');
      adresseInput.value = pick('adresse', 'address');
      nationaliteInput.value = pick('nationalite', 'nationalité', 'nationality');
      numeroSecuInput.value = pick('numero_secu', 'numéro de secu', 'numero de secu', 'nss', 'num_secu');
      dateDebutInput.value = pick('date_debut', 'date debut', 'start_date');

      // 1) Normaliser dates en DD/MM/YYYY côté client si besoin
      const normalizeDate = (v) => {
        if (!v) return v;
        const s = String(v).trim();
        // YYYY-MM-DD -> DD/MM/YYYY
        const mIso = s.match(/^\s*(\d{4})-(\d{2})-(\d{2})/);
        if (mIso) return `${mIso[3]}/${mIso[2]}/${mIso[1]}`;
        // DD-MM-YYYY -> DD/MM/YYYY
        const mDash = s.match(/^\s*(\d{2})-(\d{2})-(\d{4})/);
        if (mDash) return `${mDash[1]}/${mDash[2]}/${mDash[3]}`;
        return s;
      };
      dateNaissanceInput.value = normalizeDate(dateNaissanceInput.value);
      dateDebutInput.value = normalizeDate(dateDebutInput.value);

      // 2) Si lieu de naissance manquant et "adresse" ressemble à un lieu (ex: PARIS 14E ARRONDISSEMENT)
      const looksLikeBirthplace = (txt) => {
        if (!txt) return false;
        const t = String(txt).trim();
        const hasDigit = /\d/.test(t);
        if (/ARRONDISSEMENT/i.test(t)) return true;
        // Pas de chiffres et pas trop long -> probablement un toponyme
        return !hasDigit && t.length > 0 && t.length <= 40;
      };
      if ((!lieuNaissanceInput.value || !lieuNaissanceInput.value.trim()) && looksLikeBirthplace(adresseInput.value)) {
        lieuNaissanceInput.value = adresseInput.value;
        adresseInput.value = '';
      }
    }

    // Copier tableau (TSV)
    // (supprimé) Bouton copyTableBtn remplacé par copyBtn

    // Télécharger CSV (bouton absent, fonctionnalité inactive)

    // Générer contrat
    generateBtn.addEventListener('click', async () => {
      const payload = {
        store: storeSelect.value,
        prenom: prenomInput.value || '',
        nom: nomInput.value || '',
        date_naissance: dateNaissanceInput.value || '',
        lieu_naissance: lieuNaissanceInput.value || '',
        adresse: adresseInput.value || '',
        nationalite: nationaliteInput.value || '',
        numero_secu: numeroSecuInput.value || '',
        date_debut: dateDebutInput.value || ''
      };
      statusGenerate.textContent = 'Génération en cours…';
      try {
        const res = await fetch('/contracts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const text = await res.text();
        let body = null; try { body = text ? JSON.parse(text) : null; } catch {}
        if (!res.ok) throw new Error(body?.detail || text || 'Erreur serveur');
        statusGenerate.innerHTML = 'Contrat généré. ' + (body && body.generated_doc_url ? `<a href="${body.generated_doc_url}" target="_blank">Télécharger le PDF</a>` : '');
      } catch (e) {
        statusGenerate.textContent = 'Erreur: ' + (e?.message || String(e));
      }
    });

    // -------- Contrats: chargement & rendu --------
    const contractsStore = document.getElementById('contractsStore');
    const contractsSearch = document.getElementById('contractsSearch');
    const contractsRefresh = document.getElementById('contractsRefresh');
    const contractsTable = document.getElementById('contractsTable');
    const contractsStatus = document.getElementById('contractsStatus');

    async function loadContracts() {
      try {
        contractsStatus.textContent = 'Chargement…';
        const params = new URLSearchParams();
        if (contractsStore && contractsStore.value) params.set('store', contractsStore.value);
        params.set('limit', '200');
        const res = await fetch('/contracts?' + params.toString());
        const body = await res.json();
        if (!res.ok) throw new Error(body?.detail || 'Erreur serveur');
        contractsDataCache = body;
        renderContracts(contractsDataCache);
        // Après rendu, la hauteur peut changer -> recalculer
        adjustPillNavCompensation();
      } catch (e) {
        contractsStatus.textContent = 'Erreur: ' + (e?.message || String(e));
        if (contractsTable) contractsTable.querySelector('tbody').innerHTML = '';
      }
    }

    let contractsDataCache = null; // dernier payload brut
    let contractsSortKey = null;   // 'store' | 'prenom' | 'nom' | 'date_debut'
    let contractsSortDir = 'asc';  // 'asc' | 'desc'

    function renderContracts(data) {
      const raw = Array.isArray(data?.items) ? data.items : [];
      // Déduplication par (store, prenom, nom, date_debut) en gardant le plus récent
      const toKey = (c) => [
        (c.store || '').trim().toLowerCase(),
        (c.prenom || '').trim().toLowerCase(),
        (c.nom || '').trim().toLowerCase(),
        (c.date_debut || '').trim()
      ].join('|');
      const toScore = (c) => {
        const ts = Date.parse(c.created_at || '') || 0;
        const idNum = (typeof c.id === 'number') ? c.id : parseInt(c.id, 10) || 0;
        return ts * 1e3 + idNum; // priorise created_at, puis id
      };
      const bestByKey = new Map();
      for (const c of raw) {
        const k = toKey(c);
        const cur = bestByKey.get(k);
        if (!cur || toScore(c) > toScore(cur)) {
          bestByKey.set(k, c);
        }
      }
      let items = Array.from(bestByKey.values());

      // Filtrage client global (magasin, prénom, nom, date_debut)
      const term = (contractsSearch?.value || '').trim().toLowerCase();
      if (term) {
        items = items.filter(c => {
          const vals = [c.store, c.prenom, c.nom, c.date_debut]
            .map(v => (v == null ? '' : String(v)).toLowerCase());
        return vals.some(v => v.includes(term));
        });
      }

      // Tri selon la colonne choisie
      if (contractsSortKey) {
        const key = contractsSortKey;
        const dir = contractsSortDir === 'desc' ? -1 : 1;
        const parseDateFr = (s) => {
          if (!s) return 0;
          const m = String(s).match(/^(\d{2})\/(\d{2})\/(\d{4})/);
          if (m) {
            const dd = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10) - 1;
            const yyyy = parseInt(m[3], 10);
            return new Date(yyyy, mm, dd).getTime();
          }
          // fallback: Date.parse
          const t = Date.parse(s);
          return isNaN(t) ? 0 : t;
        };
        items.sort((a, b) => {
          let va = a?.[key];
          let vb = b?.[key];
          if (key === 'date_debut') {
            va = parseDateFr(va);
            vb = parseDateFr(vb);
            return (va - vb) * dir;
          }
          const sa = (va == null ? '' : String(va)).toLowerCase();
          const sb = (vb == null ? '' : String(vb)).toLowerCase();
          return sa.localeCompare(sb, 'fr') * dir;
        });
      }

      const tbody = contractsTable.querySelector('tbody');
      tbody.innerHTML = '';
      const formatCreated = (v) => {
        if (!v) return '';
        const s = String(v);
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return `${m[3]}/${m[2]}/${m[1]}`;
        const d = new Date(s);
        if (!isNaN(d)) {
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const yyyy = d.getFullYear();
          return `${dd}/${mm}/${yyyy}`;
        }
        return s;
      };
      for (const c of items) {
        const tr = document.createElement('tr');
        const pdf = c.generated_doc_url ? `<a href="${c.generated_doc_url}" target="_blank">Télécharger</a>` : '';
        tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.store || ''}</td>
          <td>${c.prenom || ''}</td>
          <td>${c.nom || ''}</td>
          <td>${c.date_debut || ''}</td>
          <td>${pdf}</td>
          <td>${formatCreated(c.created_at)}</td>
        `;
        tbody.appendChild(tr);
      }
      // Compteur après filtre
      if (contractsStatus) contractsStatus.textContent = `${items.length} contrat(s)`;
    }

    if (contractsRefresh) contractsRefresh.addEventListener('click', loadContracts);
    if (contractsStore) contractsStore.addEventListener('change', loadContracts);
    if (contractsSearch) contractsSearch.addEventListener('input', () => { if (contractsDataCache) renderContracts(contractsDataCache); });

    // Tri au clic sur en-tête
    document.querySelectorAll('#contractsTable thead th.contracts-col').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-key');
        if (!key) return;
        if (contractsSortKey === key) {
          contractsSortDir = (contractsSortDir === 'asc') ? 'desc' : 'asc';
        } else {
          contractsSortKey = key;
          contractsSortDir = 'asc';
        }
        // style actif
        document.querySelectorAll('#contractsTable thead th.contracts-col').forEach(h => h.classList.remove('active'));
        th.classList.add('active');
        if (contractsDataCache) renderContracts(contractsDataCache);
      });
    });
  </script>
</body>
</html>
